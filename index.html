<!DOCTYPE html>
<html lang="es">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Lector PDF & OCR - MarcosVazques20</title>
        <style>
                :root {
                        --primary: #6200EE;
                        /* Color de purple_500 en tu proyecto */
                        --bg: #F5F5F5;
                        --surface: #FFFFFF;
                        --text: #000000;
                }

                .dark-mode {
                        --bg: #121212;
                        --surface: #1E1E1E;
                        --text: #FFFFFF;
                }

                body {
                        font-family: 'Segoe UI', Roboto, sans-serif;
                        background-color: var(--bg);
                        color: var(--text);
                        margin: 0;
                        padding-bottom: 100px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        overscroll-behavior-y: contain;
                        transition: background-color 0.3s;
                }

                .app-bar {
                        width: 100%;
                        padding: 15px;
                        text-align: center;
                        background: var(--primary);
                        color: white;
                        font-weight: bold;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                        position: sticky;
                        top: 0;
                        z-index: 1000;
                }

                #viewer-container {
                        position: relative;
                        margin: 15px auto;
                        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                        background: white;
                        line-height: 0;
                }

                canvas {
                        max-width: 100vw;
                        height: auto;
                        display: block;
                }

                /* Capa interactiva de selecci√≥n de texto */
                #text-layer {
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        z-index: 10;
                        color: transparent;
                        pointer-events: all;
                        user-select: text;
                        -webkit-user-select: text;
                }

                .ocr-span {
                        position: absolute;
                        color: transparent;
                        white-space: pre;
                        transform-origin: 0 0;
                        line-height: 1;
                }

                /* Estilo de la barra inferior de botones */
                .controls {
                        position: fixed;
                        bottom: 0;
                        width: 100%;
                        background: var(--surface);
                        padding: 12px 0;
                        display: flex;
                        justify-content: space-around;
                        align-items: center;
                        box-shadow: 0 -3px 12px rgba(0, 0, 0, 0.15);
                        z-index: 1000;
                }

                .btn-fab {
                        background: var(--primary);
                        color: white;
                        border: none;
                        width: 48px;
                        height: 48px;
                        border-radius: 50%;
                        font-size: 1.3rem;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                        cursor: pointer;
                }

                .btn-fab:active {
                        transform: scale(0.9);
                }

                #loading {
                        position: fixed;
                        top: 65px;
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 6px 18px;
                        border-radius: 20px;
                        font-size: 0.8rem;
                        display: none;
                        z-index: 2000;
                }

                .page-info {
                        font-weight: bold;
                        font-size: 0.9rem;
                }
        </style>
</head>

<body>

        <div class="app-bar">Lector PDF & OCR</div>
        <div id="loading">Detecci√≥n de texto activa...</div>

        <div id="viewer-container">
                <canvas id="pdf-canvas"></canvas>
                <div id="text-layer"></div>
        </div>

        <div class="controls">
                <input type="file" id="file-input" accept="application/pdf" style="display:none">
                <button class="btn-fab" onclick="document.getElementById('file-input').click()"
                        title="Abrir">üìÅ</button>
                <button class="btn-fab" id="prev">‚óÄ</button>
                <span class="page-info" id="page-num">0 / 0</span>
                <button class="btn-fab" id="next">‚ñ∂</button>
                <button class="btn-fab" id="btn-listen" title="Escuchar">üîä</button>
                <button class="btn-fab" id="btn-translate" title="Traducir">üåç</button>
                <button class="btn-fab" id="btn-clear" title="Limpiar Selecci√≥n" style="background:#757575">üßπ</button>

                <div style="text-align: center;">
                        <input type="checkbox" id="dark-switch"><br>
                        <span style="font-size: 0.6rem; font-weight: bold;">MODO</span>
                </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
        <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>

        <script>
                let pdfDoc = null, pageNum = 1;
                const canvas = document.getElementById('pdf-canvas');
                const textLayer = document.getElementById('text-layer');
                const loading = document.getElementById('loading');

                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

                // 1. Copiado autom√°tico al portapapeles (Como en tu MainActivity)
                document.addEventListener('selectionchange', () => {
                        const selectedText = window.getSelection().toString().trim();
                        if (selectedText.length > 0) {
                                navigator.clipboard.writeText(selectedText);
                        }
                });

                // 2. Funci√≥n de Limpiar Selecci√≥n
                document.getElementById('btn-clear').onclick = () => {
                        window.getSelection().removeAllRanges();
                };

                // 3. Abrir PDF
                document.getElementById('file-input').onchange = e => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = function () {
                                const data = new Uint8Array(this.result);
                                pdfjsLib.getDocument(data).promise.then(pdf => {
                                        pdfDoc = pdf;
                                        renderPage(1);
                                });
                        };
                        reader.readAsArrayBuffer(file);
                };

                // 4. Mostrar P√°gina
                async function renderPage(num) {
                        pageNum = num;
                        const page = await pdfDoc.getPage(num);
                        const viewport = page.getViewport({ scale: 1.5 });
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                        document.getElementById('page-num').innerText = `${num} / ${pdfDoc.numPages}`;

                        runOCR();
                }

                // 5. OCR Japon√©s (Reemplaza ML Kit de Android)
                async function runOCR() {
                        loading.style.display = 'block';
                        textLayer.innerHTML = '';

                        const result = await Tesseract.recognize(canvas, 'jpn');

                        result.data.lines.forEach(line => {
                                const span = document.createElement('span');
                                span.className = 'ocr-span';
                                const b = line.bbox;

                                // Posicionamiento preciso sobre el PDF
                                span.style.left = `${b.x0}px`;
                                span.style.top = `${b.y0}px`;
                                span.style.fontSize = `${b.y1 - b.y0}px`;
                                span.style.width = `${b.x1 - b.x0}px`;

                                span.innerText = line.text;
                                textLayer.appendChild(span);
                        });
                        loading.style.display = 'none';
                }

                // 6. Botones de Acci√≥n (DeepL y TTS de tu c√≥digo original)
                document.getElementById('btn-translate').onclick = () => {
                        const text = window.getSelection().toString();
                        if (text) window.open(`https://www.deepl.com/translator#any/es/${encodeURIComponent(text)}`, '_blank');
                };

                document.getElementById('btn-listen').onclick = () => {
                        const text = window.getSelection().toString();
                        if (text) {
                                const msg = new SpeechSynthesisUtterance(text);
                                msg.lang = 'ja-JP';
                                window.speechSynthesis.speak(msg);
                        }
                };

                // Navegaci√≥n
                document.getElementById('prev').onclick = () => { if (pageNum > 1) renderPage(--pageNum); };
                document.getElementById('next').onclick = () => { if (pageNum < pdfDoc.numPages) renderPage(++pageNum); };

                // Modo Oscuro (Mismo filtro que en tu MainActivity.kt)
                document.getElementById('dark-switch').onchange = e => {
                        document.body.classList.toggle('dark-mode', e.target.checked);
                        canvas.style.filter = e.target.checked ? "invert(1) hue-rotate(180deg)" : "none";
                };
        </script>
</body>

</html>