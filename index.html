<!DOCTYPE html>
<html lang="es">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Kindle Lens Reader</title>
        <style>
                :root {
                        --primary: #4285F4;
                        --bg: #121212;
                        --panel: #1e1e1e;
                        --text: #e0e0e0;
                }

                body {
                        font-family: 'Segoe UI', Roboto, sans-serif;
                        background: var(--bg);
                        color: var(--text);
                        margin: 0;
                        height: 100vh;
                        display: flex;
                        flex-direction: column;
                        overflow: hidden;
                }

                /* BARRA SUPERIOR: Centrada y elegante */
                .header {
                        height: 60px;
                        background: var(--panel);
                        display: grid;
                        grid-template-columns: 100px 1fr 100px;
                        align-items: center;
                        padding: 0 15px;
                        border-bottom: 1px solid #333;
                        z-index: 100;
                }

                .btn-open {
                        background: var(--primary);
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 6px;
                        font-weight: bold;
                        font-size: 0.8rem;
                        cursor: pointer;
                }

                #page-center-display {
                        text-align: center;
                        font-weight: bold;
                        color: var(--primary);
                        font-size: 1rem;
                        letter-spacing: 1px;
                }

                /* √ÅREA DE LECTURA */
                #viewer-container {
                        flex: 1;
                        overflow: auto;
                        display: flex;
                        justify-content: center;
                        padding: 20px 10px;
                        background: #2b2b2b;
                        /* Fondo neutro para resaltar el papel */
                }

                #canvas-box {
                        position: relative;
                        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7);
                        background: white;
                        border-radius: 2px;
                }

                canvas {
                        display: block;
                        max-width: 100%;
                        height: auto;
                }

                /* BOT√ìN FLOTANTE LENS */
                #lens-btn {
                        position: fixed;
                        bottom: 90px;
                        right: 25px;
                        width: 65px;
                        height: 65px;
                        background: white;
                        border-radius: 50%;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
                        z-index: 200;
                        border: 4px solid var(--primary);
                        cursor: pointer;
                        transition: transform 0.2s;
                }

                #lens-btn:active {
                        transform: scale(0.9);
                }

                /* BARRA DE NAVEGACI√ìN INFERIOR */
                .footer {
                        height: 75px;
                        background: var(--panel);
                        display: flex;
                        justify-content: space-around;
                        align-items: center;
                        border-top: 1px solid #333;
                }

                .nav-button {
                        background: transparent;
                        border: 2px solid #444;
                        color: white;
                        padding: 10px 30px;
                        border-radius: 25px;
                        font-size: 1rem;
                        font-weight: bold;
                        cursor: pointer;
                        transition: 0.3s;
                }

                .nav-button:active {
                        background: #333;
                        border-color: var(--primary);
                }
        </style>
</head>

<body>

        <div class="header">
                <button class="btn-open" onclick="document.getElementById('file-in').click()">üìÅ ABRIR</button>
                <div id="page-center-display">P√ÅGINA 0 / 0</div>
                <div style="text-align: right;">
                        <input type="file" id="file-in" style="display:none" accept="application/pdf">
                </div>
        </div>

        <div id="lens-btn" onclick="captureToLens()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/f7/Google_Lens_2021_logo.svg" width="38">
        </div>

        <div id="viewer-container">
                <div id="canvas-box">
                        <canvas id="pdf-render"></canvas>
                </div>
        </div>

        <div class="footer">
                <button class="nav-button" onclick="movePage(-1)">ANTERIOR</button>
                <button class="nav-button" onclick="movePage(1)">SIGUIENTE</button>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

        <script>
                let pdfDoc = null, pageNum = 1, isRendering = false;
                const canvas = document.getElementById('pdf-render');
                const ctx = canvas.getContext('2d');

                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

                // Manejador de Archivos
                document.getElementById('file-in').onchange = e => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = function () {
                                const data = new Uint8Array(this.result);
                                pdfjsLib.getDocument(data).promise.then(pdf => {
                                        pdfDoc = pdf;
                                        render(1);
                                });
                        };
                        reader.readAsArrayBuffer(file);
                };

                async function render(num) {
                        if (isRendering || !pdfDoc) return;
                        isRendering = true;
                        pageNum = num;

                        const page = await pdfDoc.getPage(num);
                        const viewport = page.getViewport({ scale: 1.8 }); // Zoom optimizado para lectura

                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                        // Actualizar contador central
                        document.getElementById('page-center-display').innerText = `P√ÅGINA ${num} / ${pdfDoc.numPages}`;

                        isRendering = false;
                }

                function movePage(delta) {
                        const next = pageNum + delta;
                        if (next > 0 && next <= pdfDoc.numPages) render(next);
                }

                // Funci√≥n Integrada para Google Lens
                function captureToLens() {
                        if (!pdfDoc) return;

                        const imageData = canvas.toDataURL("image/jpeg", 0.9);
                        const blob = dataURLtoBlob(imageData);
                        const file = new File([blob], "capture.jpg", { type: "image/jpeg" });

                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                                navigator.share({
                                        files: [file],
                                        title: 'Lens Scan',
                                }).catch(e => console.log("Share failed", e));
                        } else {
                                // Fallback: Descarga r√°pida para que el usuario la abra en Lens manualmente
                                const link = document.createElement('a');
                                link.download = 'scan_to_lens.jpg';
                                link.href = imageData;
                                link.click();
                                alert("Imagen guardada. √Åbrela con Google Lens.");
                        }
                }

                function dataURLtoBlob(dataurl) {
                        let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                        while (n--) u8arr[n] = bstr.charCodeAt(n);
                        return new Blob([u8arr], { type: mime });
                }
        </script>
</body>

</html>