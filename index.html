<!DOCTYPE html>
<html lang="es">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Lector Lens Pro - v3</title>
        <style>
                :root {
                        --accent: #4285F4;
                        --bg: #121212;
                        --panel: #2d2e31;
                }

                body {
                        font-family: sans-serif;
                        background: var(--bg);
                        margin: 0;
                        height: 100vh;
                        display: flex;
                        flex-direction: column;
                        overflow: hidden;
                }

                /* BARRA SUPERIOR FIJA: Para asegurar que los botones siempre se vean */
                .top-nav {
                        height: 65px;
                        background: var(--panel);
                        display: flex;
                        justify-content: space-around;
                        align-items: center;
                        border-bottom: 2px solid var(--accent);
                        z-index: 5000;
                }

                .action-btn {
                        background: var(--accent);
                        color: white;
                        border: none;
                        padding: 10px 15px;
                        border-radius: 8px;
                        font-weight: bold;
                        font-size: 0.9rem;
                        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
                }

                /* √ÅREA DEL PDF */
                #viewer-area {
                        flex: 1;
                        overflow: auto;
                        display: flex;
                        justify-content: center;
                        padding: 15px;
                }

                #wrapper {
                        position: relative;
                        background: white;
                        border: 3px solid #444;
                }

                canvas {
                        display: block;
                        max-width: 100%;
                        height: auto;
                }

                /* CAPA LENS */
                #lens-overlay {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        z-index: 10;
                        cursor: text;
                }

                .lens-box {
                        position: absolute;
                        color: transparent;
                        user-select: text;
                        -webkit-user-select: text;
                }

                .lens-box::selection {
                        background: rgba(66, 133, 244, 0.4);
                }

                /* MEN√ö DE ACCI√ìN (FLOTANTE) */
                #pop-menu {
                        position: fixed;
                        display: none;
                        background: #ffffff;
                        color: #000;
                        padding: 12px;
                        border-radius: 12px;
                        z-index: 9000;
                        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
                        gap: 10px;
                }

                #pop-menu button {
                        border: none;
                        background: #f1f3f4;
                        padding: 8px;
                        font-weight: bold;
                        border-radius: 4px;
                }

                /* BARRA DE P√ÅGINAS INFERIOR */
                .bottom-nav {
                        height: 55px;
                        background: var(--panel);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        gap: 20px;
                }

                .page-btn {
                        background: none;
                        border: 1px solid #777;
                        color: white;
                        padding: 5px 20px;
                        border-radius: 20px;
                        font-size: 1.2rem;
                }
        </style>
</head>

<body>

        <div class="top-nav">
                <button class="action-btn" onclick="document.getElementById('in').click()">ABRIR PDF üìÅ</button>
                <input type="file" id="in" style="display:none" accept="application/pdf">
                <span id="p-info" style="color:white; font-weight:bold;">0 / 0</span>
                <button class="action-btn" onclick="toggleDark()">MODO üåì</button>
        </div>

        <div id="pop-menu">
                <button onclick="copy()">Copiar</button>
                <button onclick="translate()">DeepL</button>
                <button onclick="speak()">Escuchar</button>
        </div>

        <div id="viewer-area">
                <div id="wrapper">
                        <canvas id="c"></canvas>
                        <div id="lens-overlay"></div>
                </div>
        </div>

        <div class="bottom-nav">
                <button class="page-btn" onclick="move(-1)">‚Äπ Ant</button>
                <button class="page-btn" onclick="move(1)">Sig ‚Ä∫</button>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
        <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>

        <script>
                let doc = null, curP = 1, loading = false;
                const cvs = document.getElementById('c'), ctx = cvs.getContext('2d');
                const overlay = document.getElementById('lens-overlay'), menu = document.getElementById('pop-menu');

                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

                // Men√∫ flotante al seleccionar
                document.addEventListener('selectionchange', () => {
                        const s = window.getSelection();
                        if (s.toString().trim()) {
                                const r = s.getRangeAt(0).getBoundingClientRect();
                                menu.style.display = 'flex';
                                menu.style.top = (r.top - 65) + 'px';
                                menu.style.left = Math.max(10, r.left) + 'px';
                        } else { menu.style.display = 'none'; }
                });

                document.getElementById('in').onchange = e => {
                        const f = e.target.files[0];
                        const r = new FileReader();
                        r.onload = function () {
                                pdfjsLib.getDocument(new Uint8Array(this.result)).promise.then(p => { doc = p; render(1); });
                        };
                        r.readAsArrayBuffer(f);
                };

                async function render(n) {
                        if (loading) return; loading = true; curP = n;
                        const p = await doc.getPage(n);
                        const v = p.getViewport({ scale: 1.5 });
                        cvs.height = v.height; cvs.width = v.width;
                        await p.render({ canvasContext: ctx, viewport: v }).promise;
                        document.getElementById('p-info').innerText = `${n} / ${doc.numPages}`;
                        overlay.innerHTML = '';
                        loading = false;
                        doOCR();
                }

                async function doOCR() {
                        const res = await Tesseract.recognize(cvs, 'jpn');
                        res.data.lines.forEach(l => {
                                const s = document.createElement('span');
                                s.className = 'lens-box';
                                const b = l.bbox;
                                s.style.left = b.x0 + 'px'; s.style.top = b.y0 + 'px';
                                s.style.width = (b.x1 - b.x0) + 'px'; s.style.height = (b.y1 - b.y0) + 'px';
                                s.style.fontSize = (b.y1 - b.y0) + 'px';
                                s.innerText = l.text;
                                overlay.appendChild(s);
                        });
                }

                function move(d) { const n = curP + d; if (n > 0 && n <= doc.numPages) render(n); }
                function copy() { navigator.clipboard.writeText(window.getSelection().toString()); }
                function translate() { window.open(`https://www.deepl.com/translator#any/es/${encodeURIComponent(window.getSelection().toString())}`); }
                function speak() { const u = new SpeechSynthesisUtterance(window.getSelection().toString()); u.lang = 'ja-JP'; window.speechSynthesis.speak(u); }
                function toggleDark() {
                        document.body.style.filter = document.body.style.filter ? '' : 'invert(0.9) hue-rotate(180deg)';
                }
        </script>
</body>

</html>